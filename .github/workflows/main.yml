name: Python QA Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        pip install -r front/requirements.txt

    - name: Run Linters (PEP 8) and create report
      run: |        
        # Run flake8 and save output to a file for artifacts
        # --exit-zero ensures the pipeline continues to generate artifacts
        flake8 . --output-file=flake8-report.txt --exit-zero
    
    - name: Run All Tests and Generate Coverage Report
      run: |
        # Run tests for all modules
        # Generate HTML coverage report
        # Removed --cov-fail-under as requested
        pytest tests/ --cov=backend --cov=front --cov-report=html --cov-report=xml:coverage.xml
    
    - name: Upload Linter Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: linter-report
        path: flake8-report.txt

    - name: Upload Coverage Report Artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov

  docker-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Verify Docker Build
      run: |
        # This step directly builds the images from your docker-compose.yml
        # to verify they build correctly without running them.
        ./run.sh